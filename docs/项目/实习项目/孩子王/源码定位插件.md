# æºç å®šä½æ’ä»¶

## èƒŒæ™¯

æˆ‘æ¥æ‰‹äº†ä¸€ä¸ªå…¬å¸ 8 ä¸ªæœˆå‰çš„é¡¹ç›®ï¼Œç”±äºä¸Šä¸€ä¸ª coder ä»»åŠ¡å·¥æœŸè¾ƒçŸ­ï¼Œå¾ˆå¤šç»„ä»¶éƒ½æ²¡æœ‰è¿›è¡Œæ‹†åˆ†å¤ç”¨ï¼Œéƒ½æ˜¯ cv å†™çš„ï¼Œå¯¼è‡´é¡¹ç›®ä¸­æœ‰å¾ˆå¤šé‡å¤çš„ç»„ä»¶ï¼Œä¸åŒé¡µé¢åŠŸèƒ½ç›¸åŒçš„ç»„ä»¶æ¯”æ¯”çš†æ˜¯ï¼Œå¯¼è‡´ç»´æŠ¤å˜å¾—å¾ˆå›°éš¾ï¼Œå°¤å…¶æ˜¯ç»„ä»¶å®šä½ã€‚

é‚£æˆ‘ä»¬å¹³æ—¶æ˜¯å¦‚ä½•å®šä½åˆ°ç»„ä»¶åœ¨é¡¹ç›®ä¸­çš„ä½ç½®çš„å‘¢ï¼Ÿ
ä¸€èˆ¬çš„æµç¨‹æ˜¯ï¼šæ‰“å¼€é¡µé¢æ‰€åœ¨çš„è·¯ç”±è·¯å¾„ï¼Œå» Â routerÂ  é…ç½®æ–‡ä»¶å»æ‰¾å¯¹åº”çš„é¡µé¢è·¯ç”±ï¼Œå…¨å±€æœç´¢ä¸€äº›å…³é”®å­—è¿›è¡Œå®šä½ã€‚

ä½†æ˜¯å¯¹äºé¡µé¢ä¸­ç»„ä»¶å¥—ç»„ä»¶ï¼Œè¿™æ ·æ‰¾èµ·æ¥å¯å¤ªç—›è‹¦äº†ï¼Œæ‰€ä»¥æƒ³åˆ°ä¸€ä¸ªåŠæ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šå€ŸåŠ©æ„å»ºåŠŸèƒ½æ¥å¸®åŠ©æˆ‘ä»¬å®šä½æºç ä½ç½®ã€‚ï¼ˆæ€è·¯æ¥æºäºï¼šÂ https://inspector.fe-dev.cn/Â ï¼‰

è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

1. **æ„å»ºé˜¶æ®µ**ï¼ˆå€ŸåŠ© vite æ’ä»¶ï¼‰
   - é€šè¿‡æ’ä»¶çš„ `transform` é’©å­å¯ä»¥è¯†åˆ«åˆ° `.vue` æ–‡ä»¶
   - å¯¹ vue æ–‡ä»¶çš„æ ¹èŠ‚ç‚¹æ·»åŠ ä¸Šè·¯å¾„æ ‡è®°ï¼ˆé‡‡ç”¨è‡ªå®šä¹‰å±æ€§ï¼Œä¾‹å¦‚ `code-path: '/xxx/xx.vue'`ï¼‰
   - å¯¹è·¯å¾„è¿›è¡Œå‹ç¼©ï¼Œå¥½å¤„æœ‰ï¼š
     - æ–‡ä»¶ä½“ç§¯ä¼˜åŒ–ï¼ˆå¦‚æœåªæ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä¸å½±å“ï¼‰ï¼šå‡å°æ„å»ºäº§ç‰©ä½“ç§¯ã€å‡å°ç½‘ç»œä¼ è¾“å¼€é”€
     - è¿è¡Œæ—¶æ€§èƒ½æå‡ï¼šåŠ é€Ÿ dom æ“ä½œï¼Œå¯ä»¥æå‡ dom diff æ•ˆç‡
     - å®‰å…¨æ€§ï¼šåŸå§‹è·¯å¾„å¯èƒ½åŒ…å«æœåŠ¡å™¨ç›®å½•ç»“æ„ï¼ˆå¦‚`src/admin/internal/`ï¼‰ï¼Œå‹ç¼©åæ··æ·†è·¯å¾„å¯é™ä½æºç ç»“æ„æš´éœ²é£é™©ï¼Œå¢å¼ºå®‰å…¨æ€§
2. **ç¼–è¯‘é˜¶æ®µ**ï¼ˆå€ŸåŠ© vue çš„ sfc æ¨¡ç‰ˆç¼–è¯‘ï¼‰
   - vue æ¨¡ç‰ˆç¼–è¯‘æ¥æ”¶åˆ°ä¿®æ”¹åçš„ä»£ç ï¼Œé€šè¿‡ ast è¯†åˆ«å¸¦æœ‰è‡ªå®šä¹‰å±æ€§çš„å…ƒç´ ï¼Œæ‰¾åˆ°å½“å‰æ–‡ä»¶çš„æ‰€æœ‰æ ¹èŠ‚ç‚¹ï¼ˆvue3 å¯èƒ½æœ‰å¤šä¸ªæ ¹èŠ‚ç‚¹ï¼‰ï¼ŒèŠ‚ç‚¹ä¸Šåˆ¤æ–­æ˜¯å¦æœ‰è‡ªå®šä¹‰å±æ€§ï¼Œå¦‚æœæœ‰å°±æ·»åŠ ç»™èŠ‚ç‚¹çš„ `class` ä¸Šæ–°å¢ç±»åï¼š`code-locate-path-flag:xxx`
3. **è¿è¡Œæ—¶é˜¶æ®µ**ï¼ˆæ§åˆ¶å°é¢„è§ˆ/æ²¹çŒ´è„šæœ¬å¯è§†åŒ–æŸ¥çœ‹ï¼‰
   - åœ¨æ§åˆ¶å°é¢„è§ˆå°±ä¸å»ºè®®å¯¹è·¯å¾„è¿›è¡Œå‹ç¼©ï¼šç›´æ¥åœ¨æ§åˆ¶å°å…ƒç´ é‚£éƒ¨åˆ†å¯ä»¥ç›´æ¥é€‰ä¸­å…ƒç´ è¿›è¡Œè·¯å¾„æŸ¥çœ‹
   - æ²¹çŒ´è„šæœ¬ï¼šè¯†åˆ«é¡µé¢ä¸Šæ‰€æœ‰å¸¦ç‰¹å®š `class` çš„å…ƒç´ ï¼Œå°†å…¶ä»–è§£ç å‡ºæºè·¯å¾„ï¼Œç‚¹å‡» `Inspect` æŒ‰é’®ï¼Œé«˜äº®æ‰€æœ‰æ ‡è¯†å…ƒç´ 

## å…·ä½“å®ç°

### 1ã€å®‰è£…ä¾èµ–

- lz-stringï¼šä»£ç å‹ç¼©
- @vue/compiler-sfcï¼šæ¨¡ç‰ˆç¼–è¯‘

### 2ã€ç¼–å†™ vite æ’ä»¶

åˆ›å»º `plugin/code-locate.ts` æ–‡ä»¶ï¼Œç›®çš„ï¼šåœ¨ vue æ–‡ä»¶çš„æ ¹èŠ‚ç‚¹æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼Œå±æ€§å€¼ä¸ºå‹ç¼©åçš„è·¯å¾„

```ts
import LZString from 'lz-string'
import { Plugin } from 'vite'

import {
  AttributeNode,
  ElementNode,
  NodeTypes,
  TransformContext
} from '@vue/compiler-core'
import { parse } from '@vue/compiler-sfc'

const CUSTOM_ATTR = 'code-locate-path'

// viteæ’ä»¶ï¼Œç»™æ¯ä¸ªé¡µé¢çš„æ ¹èŠ‚ç‚¹ï¼ˆtemplateä¸‹çš„ä¸€çº§èŠ‚ç‚¹ï¼‰æ·»åŠ è‡ªå®šä¹‰å±æ€§code-locate-path
export function CodeLocatePlugin({
  isScript = true
}: {
  isScript: boolean
}): Plugin {
  return {
    name: 'vite-plugin-code-locate',
    enforce: 'pre',
    transform(code: string, id: string) {
      if (!id.endsWith('.vue')) {
        return null
      }
      const { template } = parse(code).descriptor
      /**
        - template?.ast
        - template?.attrsï¼š<template> æ ‡ç­¾æœ¬èº«çš„å±æ€§ï¼ˆå¦‚ langã€srcï¼‰
        - template?.contentï¼šåŸå§‹çš„æ¨¡æ¿ä»£ç å­—ç¬¦ä¸²ï¼Œå³ <template> æ ‡ç­¾å†…çš„åŸå§‹å†…å®¹
        - template?.langï¼šæ¨¡æ¿ä½¿ç”¨çš„è¯­è¨€ï¼ˆå¦‚ pugã€htmlï¼‰ï¼Œå–è‡ª <template lang="...">
        - template?.locï¼šè®°å½•æ¨¡æ¿åœ¨åŸæ–‡ä»¶ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œç”¨äºé”™è¯¯æç¤ºæˆ–ä»£ç æ˜ å°„ã€‚
            - startï¼šèµ·å§‹ä½ç½®ï¼ˆè¡Œã€åˆ—ã€åç§»é‡ï¼‰ã€‚
            - endï¼šç»“æŸä½ç½®ï¼ˆè¡Œã€åˆ—ã€åç§»é‡ï¼‰ã€‚
            - sourceï¼šåŸå§‹å†…å®¹å­—ç¬¦ä¸²ã€‚
        - template?.mapï¼šæ¨¡æ¿çš„ä»£ç æ˜ å°„ï¼Œç”¨äºç”Ÿæˆæºä»£ç æ˜ å°„ã€‚
        - template?.srcï¼šå¤–éƒ¨æ¨¡æ¿æ–‡ä»¶çš„è·¯å¾„ï¼Œå–è‡ª <template src="...">
        - template?.typeï¼šèŠ‚ç‚¹ç±»å‹ï¼Œvnodeçš„typeå±æ€§
         */
      if (template && template.ast && template.ast.children) {
        // type: NodeTypes.ELEMENT; 1
        /**
         * <template>
         *    <div></div>
         * </template>
         * rootElmsè·å–çš„æ˜¯divèŠ‚ç‚¹
         */
        let rootElms = template.ast.children.filter((child) => {
          return child.type === 1 // 1æ˜¯å…ƒç´ èŠ‚ç‚¹
        })
        if (rootElms.length > 0) {
          // ä¾æ¬¡å¤„ç†æ¯ä¸ªæ ¹èŠ‚ç‚¹
          rootElms.forEach((rootElm) => {
            // console.log('[ğŸš€code-locate-plugin] å·²ç»æ‰¾åˆ°æ ¹å…ƒç´ ï¼š', rootElm.tag)
            const tagString = `<${rootElm.tag}`
            const insertIndex =
              rootElm.loc.source.indexOf(tagString) + tagString.length
            const compressedPath = isScript ? LZString.compressToBase64(id) : id
            // console.log('[ğŸš€code-locate-plugin] åŸå§‹è·¯å¾„', id)
            // console.log('[ğŸš€code-locate-plugin] å‹ç¼©è·¯å¾„', compressedPath)

            // æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼ˆè¿›è¡Œå­—ç¬¦ä¸²åˆ‡å‰²ï¼Œä¸­é—´æ·»åŠ å±æ€§ï¼‰
            // LZString.compressToBase64 è·¯å¾„å‹ç¼©
            const newSource = `${rootElm.loc.source.slice(
              0,
              insertIndex
            )} ${CUSTOM_ATTR}="${compressedPath}"${rootElm.loc.source.slice(
              insertIndex
            )}`
            // æ›¿æ¢åŸå§‹å†…å®¹
            code = code.replace(rootElm.loc.source, newSource)
          })
        }
      }
      return code
    }
  }
}
```

### 3ã€å¯¹ vue æ¨¡ç‰ˆç¼–è¯‘å¤„ç†

ç›®çš„ï¼šåœ¨ vue ç¼–è¯‘é˜¶æ®µï¼Œè¯†åˆ«åˆ°æ ¹ç»„ä»¶çš„è‡ªå®šä¹‰è·¯å¾„å±æ€§ï¼Œç„¶åå°†è¿™ä¸ªè‡ªå®šä¹‰è·¯å¾„å±æ€§æ·»åŠ åˆ° Â classÂ  ä¸­ï¼Œè¿™ä¸€æ­¥å…¶å®ä¸»è¦æ˜¯ä¾¿äºç»™æ²¹çŒ´è„šæœ¬æŠ“å–æ•°æ®ç”¨çš„

> ä¸ºä»€ä¹ˆä¸åœ¨ vite çš„æ—¶å€™è¿›è¡Œæ ‡è®°ï¼Ÿå› ä¸º vue3 çš„ç»„ä»¶å¯èƒ½æ˜¯å¤šä¸ªæ ¹èŠ‚ç‚¹ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨ AST è¿›è¡Œé€’å½’æ·»åŠ  class å±æ€§ï¼Œæ¯” vite åœ¨æ„å»ºæ—¶æ–¹ä¾¿ã€‚

```ts
// åœ¨vueå¯¹sfcæ¨¡ç‰ˆç¼–è¯‘é˜¶æ®µè¿›è¡Œå¤„ç†ï¼Œç»™ç»„ä»¶æ·»åŠ classæ¥æ ‡è®°è·¯å¾„
// åˆ†ä¸¤ç§ç±»å‹èŠ‚ç‚¹ï¼š1ã€vueæ–‡ä»¶æ ¹èŠ‚ç‚¹ï¼ˆç›´æ¥å¤ç”¨è‡ªå®šä¹‰å±æ€§ä¸­çš„å€¼ï¼‰2ã€æ–‡ä»¶å…¶ä»–åŒçº§æ ¹èŠ‚ç‚¹
export function CodeLocateNodeTransform(
  node: ElementNode, // å½“å‰å¤„ç†çš„astèŠ‚ç‚¹
  context: TransformContext
): void {
  /**
   * NodeTypes:
   *    ROOT=0
   *    ELEMENT=1
   *    IF_BRANCH=10ï¼šv-ifã€v-else-ifã€v-else æ‰€åœ¨çš„æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹
   * */
  // context.parentï¼šå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
  if (node.type === 1 && context.parent) {
    // å¤„ç†æ ¹èŠ‚ç‚¹å’Œå¸¦v-ifçš„çˆ¶èŠ‚ç‚¹
    if ([0, 10].includes(context.parent.type)) {
      context.parent.children.forEach((child) => {
        if (child.type === 1) {
          const customAttr =
            child &&
            child.props &&
            child.props.find((item) => item.name === CUSTOM_ATTR)
          // è‡ªå®šä¹‰å±æ€§å€¼
          const customAttrValue =
            customAttr &&
            'value' in customAttr &&
            customAttr.value &&
            customAttr.value.content
          if (customAttrValue) {
            // ç»Ÿä¸€å¤„ç†ï¼Œä¸åŒºåˆ†ç»„ä»¶ç±»å‹
            addClass(node, customAttrValue, 'class')
          }
        }
      })
    } else if ((context.parent as ElementNode).props) {
      // ç»™åŒçº§æ ¹èŠ‚ç‚¹æ·»åŠ classç±»å
      const parentMarkAttr = (context.parent as ElementNode).props.find(
        /**
         * itemç±»å‹
         * {
            type: 6,
            name: 'code-locate-path',
            value: {
              type: 2,
              content: 'PQVQzgpgTmwDYEMB2AXAlsgngV2AEQjAGsUB7AB2HKlIBNsBjdALwXVKQFooiALTTrTQBzNCgRxOvbAFtkwMFAbAAbmggB3WGF6kUa2hFKr1G4AAVsAIzhodAFQTEAkiggyAdCuwQgA=',
              ...
            },
            ...
        */
        (item) => item.name === CUSTOM_ATTR
      )
      // è·å–åˆ°è‡ªå®šä¹‰å±æ€§å€¼
      const parentMarkAttrValue =
        parentMarkAttr &&
        (parentMarkAttr as AttributeNode).value &&
        (parentMarkAttr as AttributeNode).value!.content
      if (parentMarkAttrValue) {
        // ä¸ºå­ç»„ä»¶æ·»åŠ æ ‡è®°
        addClass(node, parentMarkAttrValue, 'class')
      }
    }
  }
}

// ç”¨äºç»™å…ƒç´ æ·»åŠ ç±»å
// æœ‰ç±»åå°±æ·»åŠ ï¼Œæ²¡æœ‰å°±åˆ›å»º
function addClass(
  node: ElementNode,
  customAttrValue: string,
  className: string // atträ¸ºclassçš„
) {
  const prefix = 'code-locate-path-flag'
  const addInfo = `${prefix}:${customAttrValue}`
  const classNode =
    node.props &&
    (node.props.find(
      (prop) => prop.type === 6 && prop.name === className
    ) as AttributeNode)
  /**
   * classNode: {
      type: 6, // NodeTypes.ATTRIBUTE èŠ‚ç‚¹å±æ€§
      name: 'class',,
        value: {
          type: 2,
          content: 'btn-text',
          loc: { start: [Object], end: [Object], source: '"btn-text"' }
        },
        loc: ...
    }
  */
  if (classNode) {
    classNode.value!.content += ` ${addInfo}`
  } else {
    // æ²¡æœ‰classå±æ€§ï¼Œå»æ‰‹åŠ¨æ„é€ èŠ‚ç‚¹å±æ€§
    node.props.push({
      type: 6, // ATTRIBUTE
      name: className,
      nameLoc: node.loc,
      value: {
        type: 2, // TEXT
        content: addInfo,
        loc: node.loc
      },
      loc: node.loc
    })
  }
}
```

### 4ã€ä½¿ç”¨ vite æ’ä»¶å’Œ vue æ¨¡ç‰ˆç¼–è¯‘å¤„ç†å‡½æ•°

```ts
import { defineConfig } from 'vite'
import { CodeLocateNodeTransform, CodeLocatePlugin } from './plugin/code-locate'
import vue from '@vitejs/plugin-vue'
export default defineConfig({
  plugins: [
    vue({
      template: {
        compilerOptions: {
          nodeTransforms: [CodeLocateNodeTransform]
        }
      }
    }), // æä¾› Vue 3 å•æ–‡ä»¶ç»„ä»¶æ”¯æŒ
    CodeLocatePlugin({ isScript: false })
  ]
})
```

### 5ã€æ²¹çŒ´è„šæœ¬

è¿™ä¸ªæ–‡ä»¶å†…å®¹è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œå°±è¯´ä¸€äº›æ ¸å¿ƒåŠŸèƒ½ï¼š

1ã€å…ƒç´ è¯†åˆ«ä¸æŸ¥æ‰¾

è¿™éƒ¨åˆ†ä»£ç è´Ÿè´£åœ¨ DOM ä¸­æœç´¢å¸¦æœ‰ `code-locate-path-flag:` å‰ç¼€çš„ç±»åï¼Œè¿™äº›ç±»ååŒ…å«äº†å‹ç¼©è¿‡çš„æºæ–‡ä»¶è·¯å¾„ã€‚

```js
// è¿”å›code-locate-path-flag:çš„classå€¼
function getCssMarkClass(element) {
  const classList = element.classList
  for (let i = 0; i < classList.length; i++) {
    const className = classList[i]
    if (className.startsWith('code-locate-path-flag:')) {
      return className
    }
  }
  return ''
}
// è¿”å›classä¸­åŒ…å«code-locate-path-flag:çš„å…ƒç´ 
function getCssMarkClassElement(root) {
  const allElements = root.querySelectorAll('*')
  // è¿‡æ»¤å‡º classList ä¸­åŒ…å«ä»¥ code-locate-path-flag: å¼€å¤´çš„ç±»çš„å…ƒç´ 
  return Array.from(allElements).filter(function (element) {
    return Array.from(element.classList).some(function (className) {
      return className.startsWith('code-locate-path-flag:')
    })
  })
}
```

2ã€ç»„ä»¶å±‚æ¬¡ç»“æ„æ”¶é›†

è¿™ä¸ªå‡½æ•°ä»ç‚¹å‡»çš„å…ƒç´ å¼€å§‹å‘ä¸Šéå† DOM æ ‘ï¼Œæ”¶é›†æ‰€æœ‰å¸¦æœ‰æ ‡è®°çš„çˆ¶å…ƒç´ ï¼Œæ„å»ºç»„ä»¶å±‚æ¬¡ç»“æ„ã€‚

```js
// å‡½æ•°ï¼šæ”¶é›†ä»é¡¶å±‚åˆ°å½“å‰å…ƒç´ çš„ code-locate-path å±æ€§åˆ—è¡¨
function collectCssMarkHierarchy(element) {
  const cssMarkList = []
  while (element) {
    const cssClassName = getCssMarkClass(element)
    if (cssClassName) {
      cssMarkList.push({ element, originMark: cssClassName })
    }
    element = element.parentElement
  }
  return cssMarkList
}
```

3ã€è·¯å¾„è§£ç ä¸æ˜¾ç¤º

ä»ç±»åä¸­æå–å‹ç¼©çš„è·¯å¾„éƒ¨åˆ†ï¼Œç„¶åä½¿ç”¨ LZString.decompressFromBase64 è§£ç è¿˜åŸä¸ºå®é™…æ–‡ä»¶è·¯å¾„ã€‚

```js
// å¤„ç†æºç è·¯å¾„éƒ¨åˆ†ä»£ç 
cssMarkList.forEach((item) => {
  const tag = item.element.tagName.toLowerCase()
  try {
    const encodedPath = item.originMark.substring(prefix.length)
    const filePath = LZString.decompressFromBase64(encodedPath)
    decodedPaths.push({ tag, filePath })
  } catch (e) {
    console.error('è§£ç è·¯å¾„å¤±è´¥:', e)
  }
})
```
